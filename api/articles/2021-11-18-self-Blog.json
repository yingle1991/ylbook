{"title":"微信小程序调用腾讯地图返回 IP未被授权错误。","slug":"2021-11-18-self-Blog","date":"2021-11-17T16:00:00.000Z","updated":"2021-11-19T03:31:23.747Z","comments":true,"path":"api/articles/2021-11-18-self-Blog.json","excerpt":"功能需求微信小程序提供的接口能够获取到当前位置的坐标（经纬度），但是不能得到当前位置的地址。或者从后台获取到坐标（经纬度）要解析成文字描述的地址小程序也没有对应的接口。实现思路","covers":["https://gitee.com/yingle1991/resource/raw/master/2021-11-18/1637244751613-image.png","https://img.soogif.com/sjo887jBzEvoHHtjBdo0lAVfMbXkGtva.png?scope=mdnice","https://gitee.com/yingle1991/resource/raw/master/2021-11-18/1637244867048-image.png","https://gitee.com/yingle1991/resource/raw/master/static/blog/passme.png"],"content":"<p>功能需求</p>\n<p>微信小程序提供的接口能够获取到当前位置的坐标（经纬度），但是不能得到当前位置的地址。或者从后台获取到坐标（经纬度）要解析成文字描述的地址小程序也没有对应的接口。</p>\n<p>实现思路</p>\n<a id=\"more\"></a> \n\n<p>这时候就需要通过腾讯位置服务来实现，但在这之前需要有腾讯位置服务的账号和开发密钥（key）。实现过程我就简单参看官网上的步骤，这里主要给大家几个前车之鉴，欢迎各位小伙伴留言补充。</p>\n<p>官网：<a href=\"http://lbs.qq.com/index.html\">腾讯地图</a></p>\n<p>关键代码</p>\n<p>// 引入SDK核心类<br>var QQMapWX = require(‘../../utils/js/qqmap-wx-jssdk.js’);<br>var qqmapsdk;</p>\n<p>Page({</p>\n<pre><code>onLoad: function () &#123;\n    // 实例化API核心类\n    var qqmapsdk = new QQMapWX(&#123;\n        key: &#39;xxxx-xxxx-xxxx-xxxx-xxxx-xxxx&#39; // 开发密钥（key）必填\n    &#125;);\n&#125;,\n\n// 获取当前地理坐标\nonReady: function () &#123;\n    var _this = this;\n    wx.getLocation(&#123;\n      type: &#39;gcj02&#39;,\n      altitude: true,\n      success: (res) =&gt; &#123;\n        var latitude = res.latitude // 经度\n        var longitude = res.longitude // 纬度\n        // 根据坐标调用 pointToAddress 方法\n        _this.pointToAddress(latitude, longitude, function (address) &#123;\n            // 得到最终地址\n            console.log(address);\n        &#125;\n      &#125;\n    &#125;)\n&#125;,\n\n// 定义 pointToAddress 方法\npointToAddress: function (latitude, longitude, callback) &#123;\n    var _this = this;\n    // 调用接口\n    qqmapsdk.reverseGeocoder(&#123;\n      location: &#123;\n        latitude: latitude,\n        longitude: longitude\n      &#125;,\n      success: function (res) &#123;\n        // 解析成功返回地址\n        callback(res.result.address);\n      &#125;,\n      fail: function (res) &#123;\n        console.log(res);\n      &#125;,\n      complete: function (res) &#123;\n        console.log(res);\n      &#125;\n    &#125;);\n&#125;,</code></pre>\n<p>})</p>\n<p>报错处理</p>\n<p>常见报错（一）我在实际应用中并未遇到，这个域名写不写应该均可；</p>\n<p>报错：<a href=\"http://apis.map.qq.com/\">http://apis.map.qq.com</a> 不在以下 request 合法域名列表中</p>\n<p>原因：出现这个报错是因为你在小程序中发起了wx.request请求,但是请求的域名(<a href=\"http://apis.map.qq.com)没有在微信公众平台后台配置./\">http://apis.map.qq.com)没有在微信公众平台后台配置。</a></p>\n<p>解决方法：配置request合法域名，把<a href=\"https://apis.map.qq.com添加到你的request合法域名中.(微信公众平台—设置—开发设置—服务器域名)./\">https://apis.map.qq.com添加到你的request合法域名中。(微信公众平台—设置—开发设置—服务器域名)。</a></p>\n<p>Tips：添加后需刷新项目，并重新编译才会有效果，否则可能无效。</p>\n<p>常见报错（二）</p>\n<p><strong>此报错解决方案1仅限 在服务器端掉用时，因为服务器的IP一般是固定的，小程序报错解决方案请参照方案2</strong></p>\n<p>报错：请求来源未被授权</p>\n<p>方案1（服务端掉用）：没有配置开发密钥(key)或者配置错误。</p>\n<p>解决方法：在腾讯位置服务平台(<a href=\"https://lbs.qq.com/)%E8%AE%BE%E7%BD%AE%E5%BC%80%E5%8F%91%E5%AF%86%E9%92%A5(key)%E7%9A%84\">https://lbs.qq.com/)设置开发密钥(key)的</a> WebServiceAPI 授权IP。(控制台—密钥(key)管理—密钥设置)。</p>\n<p>第一步：勾选微信小程序，并填写小程序ID。</p>\n<p>第二步：勾选WebServiceAPI，并设置授权IP(你的服务器域名或IP)。</p>\n<p>Tips：同样添加后刷新项目，并重新编译才会有效果，否则可能无效。</p>\n<p>我的用小程序调用参照此方法设置成本地IP了，本地正常访问，但是部署到体验版，一样报错 </p>\n<p><img src=\"https://gitee.com/yingle1991/resource/raw/master/2021-11-18/1637244751613-image.png\"></p>\n<p><img src=\"https://img.soogif.com/sjo887jBzEvoHHtjBdo0lAVfMbXkGtva.png?scope=mdnice\"></p>\n<p>方案2（小程序端掉用）:</p>\n<p>解决方法：在腾讯位置服务平台(<a href=\"https://lbs.qq.com/)%E8%AE%BE%E7%BD%AE%E5%BC%80%E5%8F%91%E5%AF%86%E9%92%A5(key)%E7%9A%84\">https://lbs.qq.com/)设置开发密钥(key)的</a> WebServiceAPI 授权IP。(控制台—密钥(key)管理—密钥设置)。</p>\n<p>第一步：勾选微信小程序，并填写小程序ID。</p>\n<p>第二步：勾选域名白名单，并设置域名-》servicewechat.com。</p>\n<p><img src=\"https://gitee.com/yingle1991/resource/raw/master/2021-11-18/1637244867048-image.png\"></p>\n<p>测试结果</p>\n<p>测试没问题，能取到数据，并且零报错。</p>\n<p>Tips：这些方法不仅适用于坐标解析(reverseGeocoder)，还适用于距离计算(calculateDistance)，地点搜索(search)，获取城市列表(getCityList)等等场景。</p>\n<p>分享程序员的理财、生活！我是乐子，多多指教！</p>\n<pre><code>                                                - EOF -</code></pre>\n<p>   <img src=\"https://gitee.com/yingle1991/resource/raw/master/static/blog/passme.png\" alt=\"关注我得到更多信息\"></p>\n","more":"<p>这时候就需要通过腾讯位置服务来实现，但在这之前需要有腾讯位置服务的账号和开发密钥（key）。实现过程我就简单参看官网上的步骤，这里主要给大家几个前车之鉴，欢迎各位小伙伴留言补充。</p>\n<p>官网：<a href=\"http://lbs.qq.com/index.html\">腾讯地图</a></p>\n<p>关键代码</p>\n<p>// 引入SDK核心类<br>var QQMapWX = require(‘../../utils/js/qqmap-wx-jssdk.js’);<br>var qqmapsdk;</p>\n<p>Page({</p>\n<pre><code>onLoad: function () &#123;\n    // 实例化API核心类\n    var qqmapsdk = new QQMapWX(&#123;\n        key: &#39;xxxx-xxxx-xxxx-xxxx-xxxx-xxxx&#39; // 开发密钥（key）必填\n    &#125;);\n&#125;,\n\n// 获取当前地理坐标\nonReady: function () &#123;\n    var _this = this;\n    wx.getLocation(&#123;\n      type: &#39;gcj02&#39;,\n      altitude: true,\n      success: (res) =&gt; &#123;\n        var latitude = res.latitude // 经度\n        var longitude = res.longitude // 纬度\n        // 根据坐标调用 pointToAddress 方法\n        _this.pointToAddress(latitude, longitude, function (address) &#123;\n            // 得到最终地址\n            console.log(address);\n        &#125;\n      &#125;\n    &#125;)\n&#125;,\n\n// 定义 pointToAddress 方法\npointToAddress: function (latitude, longitude, callback) &#123;\n    var _this = this;\n    // 调用接口\n    qqmapsdk.reverseGeocoder(&#123;\n      location: &#123;\n        latitude: latitude,\n        longitude: longitude\n      &#125;,\n      success: function (res) &#123;\n        // 解析成功返回地址\n        callback(res.result.address);\n      &#125;,\n      fail: function (res) &#123;\n        console.log(res);\n      &#125;,\n      complete: function (res) &#123;\n        console.log(res);\n      &#125;\n    &#125;);\n&#125;,</code></pre>\n<p>})</p>\n<p>报错处理</p>\n<p>常见报错（一）我在实际应用中并未遇到，这个域名写不写应该均可；</p>\n<p>报错：<a href=\"http://apis.map.qq.com/\">http://apis.map.qq.com</a> 不在以下 request 合法域名列表中</p>\n<p>原因：出现这个报错是因为你在小程序中发起了wx.request请求,但是请求的域名(<a href=\"http://apis.map.qq.com)没有在微信公众平台后台配置./\">http://apis.map.qq.com)没有在微信公众平台后台配置。</a></p>\n<p>解决方法：配置request合法域名，把<a href=\"https://apis.map.qq.com添加到你的request合法域名中.(微信公众平台—设置—开发设置—服务器域名)./\">https://apis.map.qq.com添加到你的request合法域名中。(微信公众平台—设置—开发设置—服务器域名)。</a></p>\n<p>Tips：添加后需刷新项目，并重新编译才会有效果，否则可能无效。</p>\n<p>常见报错（二）</p>\n<p><strong>此报错解决方案1仅限 在服务器端掉用时，因为服务器的IP一般是固定的，小程序报错解决方案请参照方案2</strong></p>\n<p>报错：请求来源未被授权</p>\n<p>方案1（服务端掉用）：没有配置开发密钥(key)或者配置错误。</p>\n<p>解决方法：在腾讯位置服务平台(<a href=\"https://lbs.qq.com/)%E8%AE%BE%E7%BD%AE%E5%BC%80%E5%8F%91%E5%AF%86%E9%92%A5(key)%E7%9A%84\">https://lbs.qq.com/)设置开发密钥(key)的</a> WebServiceAPI 授权IP。(控制台—密钥(key)管理—密钥设置)。</p>\n<p>第一步：勾选微信小程序，并填写小程序ID。</p>\n<p>第二步：勾选WebServiceAPI，并设置授权IP(你的服务器域名或IP)。</p>\n<p>Tips：同样添加后刷新项目，并重新编译才会有效果，否则可能无效。</p>\n<p>我的用小程序调用参照此方法设置成本地IP了，本地正常访问，但是部署到体验版，一样报错 </p>\n<p><img src=\"https://gitee.com/yingle1991/resource/raw/master/2021-11-18/1637244751613-image.png\"></p>\n<p><img src=\"https://img.soogif.com/sjo887jBzEvoHHtjBdo0lAVfMbXkGtva.png?scope=mdnice\"></p>\n<p>方案2（小程序端掉用）:</p>\n<p>解决方法：在腾讯位置服务平台(<a href=\"https://lbs.qq.com/)%E8%AE%BE%E7%BD%AE%E5%BC%80%E5%8F%91%E5%AF%86%E9%92%A5(key)%E7%9A%84\">https://lbs.qq.com/)设置开发密钥(key)的</a> WebServiceAPI 授权IP。(控制台—密钥(key)管理—密钥设置)。</p>\n<p>第一步：勾选微信小程序，并填写小程序ID。</p>\n<p>第二步：勾选域名白名单，并设置域名-》servicewechat.com。</p>\n<p><img src=\"https://gitee.com/yingle1991/resource/raw/master/2021-11-18/1637244867048-image.png\"></p>\n<p>测试结果</p>\n<p>测试没问题，能取到数据，并且零报错。</p>\n<p>Tips：这些方法不仅适用于坐标解析(reverseGeocoder)，还适用于距离计算(calculateDistance)，地点搜索(search)，获取城市列表(getCityList)等等场景。</p>\n<p>分享程序员的理财、生活！我是乐子，多多指教！</p>\n<pre><code>                                                - EOF -</code></pre>\n<p>   <img src=\"https://gitee.com/yingle1991/resource/raw/master/static/blog/passme.png\" alt=\"关注我得到更多信息\"></p>","categories":[],"tags":[{"name":"开源","path":"api/tags/开源.json"},{"name":"小程序","path":"api/tags/小程序.json"}]}